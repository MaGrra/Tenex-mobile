import { useEffect, useState } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Select, SelectTrigger, SelectContent, SelectItem } from "@/components/ui/select";

const SHEETS = [
  {
    name: "Kopvērtējums",
    url: "https://docs.google.com/spreadsheets/d/1vGwEZFF1CQug9Zu-lolmuZ7ZMH5hLOklmYTydHhktaw/pub?output=csv&gid=0"
  },
  {
    name: "Rodeo",
    url: "https://docs.google.com/spreadsheets/d/1GRv7i8FD7Ergscl2znh7MkmootGrzVgSx2i1QJDpoiY/pub?output=csv&gid=0"
  },
  {
    name: "Kannas",
    url: "https://docs.google.com/spreadsheets/d/1SLgcLEFkvzDaTtQMb8UFoRMDnZSExvLN_wwiNjfwlnc/pub?output=csv&gid=0"
  },
  {
    name: "Futbols",
    url: "https://docs.google.com/spreadsheets/d/102Hxs4Ae-ZNml0tGS3NFCi0lQvJ7I2deeeNQR2Crz9s/pub?output=csv&gid=0"
  },
  {
    name: "Āķis",
    url: "https://docs.google.com/spreadsheets/d/1jokyEEJULQn_0ysiMpLp961rP5ilc-d_5ilPw0Mgjo0/pub?output=csv&gid=0"
  },
  {
    name: "Bungas",
    url: "https://docs.google.com/spreadsheets/d/1Rf5yQxaDOvrLI-d13U9E3h0LgPc5CAEVnALtkEhZ_Us/pub?output=csv&gid=0"
  },
  {
    name: "Pakavs",
    url: "https://docs.google.com/spreadsheets/d/104x2Vhi2fvGm1osQlM3EL2QGaKLfC1Sfq4phakIsRO0/pub?output=csv&gid=0"
  },
  {
    name: "Koferis",
    url: "https://docs.google.com/spreadsheets/d/1fTevBQl8cf6nPYj8WWmCscjK__6Y03vei3GGXfvp_9I/pub?output=csv&gid=0"
  },
  {
    name: "Metiens",
    url: "https://docs.google.com/spreadsheets/d/1BmPzOrS7vOc_IiZSTRRJv_sIEm7xcBFT6qjZMkp0PPE/pub?output=csv&gid=0"
  }
];

const TEAM_COLORS = {
  "Zaļā komanda": "border-green-500",
  "Zilā komanda": "border-blue-500",
  "Baltā komanda": "border-gray-300",
  "Sarkanā komanda": "border-red-500",
};

export default function ResultsMobile() {
  const [selectedSheet, setSelectedSheet] = useState(SHEETS[0]);
  const [teams, setTeams] = useState([]);

  const fetchData = async () => {
    const res = await fetch(selectedSheet.url);
    const csv = await res.text();
    const rows = csv.trim().split("\n").slice(1); // Skip header
    const parsed = rows.map((r) => r.split(","));
    const newData = parsed.map((r) => ({
      name: r[0],
      score: parseFloat(r[1]),
    })).filter(r => r.name && !isNaN(r.score));
    newData.sort((a, b) => b.score - a.score);
    setTeams(newData);
  };

  useEffect(() => {
    fetchData();
    const interval = setInterval(fetchData, 10000);
    return () => clearInterval(interval);
  }, [selectedSheet]);

  return (
    <div className="min-h-screen p-4 pt-20 bg-white">
      <div className="text-center text-3xl font-bold mb-1">Rezultāti</div>
      <div className="text-center text-sm text-gray-600 mb-4">Izvēlies disciplīnu</div>
      <div className="max-w-xs mx-auto mb-4">
        <Select onValueChange={(value) => {
          const s = SHEETS.find(s => s.name === value);
          if (s) setSelectedSheet(s);
        }}>
          <SelectTrigger>{selectedSheet.name}</SelectTrigger>
          <SelectContent>
            {SHEETS.map(sheet => (
              <SelectItem key={sheet.name} value={sheet.name}>{sheet.name}</SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      <div className="space-y-2 max-w-md mx-auto">
        {teams.map((team, idx) => (
          <Card key={team.name} className={`border-2 ${TEAM_COLORS[team.name] || "border-black"}`}>
            <CardContent className="p-3 flex justify-between items-center">
              <div className="font-medium text-base">{idx + 1}. {team.name}</div>
              <div className="text-sm font-semibold">{team.score}</div>
            </CardContent>
          </Card>
        ))}
      </div>

      <div className="text-xs text-gray-400 text-center mt-8">Build #1</div>
    </div>
  );
}
